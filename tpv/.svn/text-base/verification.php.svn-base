<?php
include "../auth/iprestrict.php";
$id = $_GET["id"];
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>VeriCon :: TPV :: Verification</title>
<link rel="shortcut icon" href="../images/vericon.ico">
<link rel="stylesheet" href="../css/inner.css" type="text/css"/>
<link rel="stylesheet" href="../jquery/development-bundle/themes/custom-theme/jquery.ui.all.css">
<script src="../jquery/development-bundle/jquery-1.6.2.js"></script>
<script src="../jquery/development-bundle/jquery-1.6.2.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.core.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.widget.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.datepicker.js"></script>
<script src="../jquery/development-bundle/external/jquery.bgiframe-2.1.2.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.mouse.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.button.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.draggable.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.position.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.resizable.js"></script>
<script src="../jquery/development-bundle/ui/jquery.ui.dialog.js"></script>
<script src="../jquery/development-bundle/ui/jquery.effects.core.js"></script>
<link rel="stylesheet" href="../jquery/development-bundle/demos/demos.css">
<style>
.loadscript
{
	background-image:url('../images/load_script_btn.png');
	background-repeat:no-repeat;
	height:30px;
	width:102px;
	border:none;
	background-color:transparent;
	margin-right:10px;
}

.loadscript:hover
{
	background-image:url('../images/load_script_btn_hover.png');
	cursor:pointer;
}

.cancelform
{
	background-image:url('../images/cancel_form_btn.png');
	background-repeat:no-repeat;
	height:30px;
	width:102px;
	border:none;
	background-color:transparent;
	margin-right:10px;
}

.cancelform:hover
{
	background-image:url('../images/cancel_form_btn_hover.png');
	cursor:pointer;
}

.addpackage
{
	background-image:url('../images/add_package_btn.png');
	background-repeat:no-repeat;
	height:30px;
	width:102px;
	border:none;
	background-color:transparent;
	margin-right:10px;
}

.addpackage:hover
{
	background-image:url('../images/add_package_btn_hover.png');
	cursor:pointer;
}

.notes
{
	background-image:url('../images/notes_btn.png');
	background-repeat:no-repeat;
	height:30px;
	width:102px;
	border:none;
	background-color:transparent;
	margin-right:10px;
}

.notes:hover
{
	background-image:url('../images/notes_btn_hover.png');
	cursor:pointer;
}

div#users-contain table { margin: 1em 0; border-collapse: collapse; }
div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
</style>
<script> //init form
function Get_Sale()
{
	var id = $( "#id" );
	
	$.get("verification_submit.php?method=get", { id: id.val() },
	function(data) {
	   
	   if (data == "valid")
	   {
		   window.location = "verification.php?id=" + id.val();
	   }
	   else
	   {
			$( ".error" ).html(data);
	   }
	});
}
</script>
<script> //add packages
$(function() {
	$( "#dialog:ui-dialog" ).dialog( "destroy" );
	
	var id = "<?php echo $id; ?>",
		cli = $( "#add_cli" ),
		plan = $( "#add_plan" ),
		tips = $( ".error" );

	function updateTips( t ) {
		tips
			.text( t )
			.addClass( "ui-state-highlight" );
		setTimeout(function() {
			tips.removeClass( "ui-state-highlight", 1500 );
		}, 500 );
	}

	$( "#dialog-form" ).dialog({
		autoOpen: false,
		height: 200,
		width: 275,
		modal: true,
		resizable: false,
		draggable: false,
		buttons: {
			"Add Package": function() {
				if (cli.val() == "")
				{
					updateTips("Enter the CLI!");
				}
				else if (plan.val() == "")
				{
					updateTips("Select a plan!");
				}
				else
				{
					$.get("verification_submit.php?method=add", { id: id, cli: cli.val(), plan: plan.val() },
					function(data) {
						if (data == "added")
						{
							$( "#dialog-form" ).dialog( "close" );
							window.location.reload(true);
						}
						else
						{
							updateTips(data);
						}
					});
				}
			},
			Cancel: function() {
				$( this ).dialog( "close" );
			}
		},
		close: function() {
		}
	});
});

function Add_Package()
{
	$( "#dialog-form" ).dialog( "open" );
}
</script>
<script> //delete packages
function Delete(cli)
{
	var id = "<?php echo $id; ?>",
		cli = cli;
	
	$.get("verification_submit.php?method=delete", { id: id, cli: cli},
	function(data) {
		if (data == "deleted")
		{
			window.location.reload(true);
		}
	});
}
</script>
<script> //load script
function LoadScript()
{
	$( "#sale_details_edit" ).css("display","none");
	$( ".type" ).html($( "#type" ).val());
	$( "#sale_details").removeAttr("style");
	$( "#tpv_notes" ).css("display","none");
	$( "#prev_attempt" ).css("display","none");
	$( "#selected_packages" ).css("display","none");
	
	var campaign = $( ".campaign" ).html() + " " + $( ".type" ).html(),
		plan = $( "#plan" ),
		alias = "<?php echo $ac["alias"]; ?>",
		id = "<?php echo $id; ?>",
		l = "../script/script_tpv.php?campaign=" + campaign + "&plan=" + plan.val() + "&alias=" + alias + "&id=" + id + "&page=1";
	document.getElementById("script").src = l;
	
	if ( $( "#type" ).val() != "<?php echo $data["type"]; ?>" )
	{
		//ajax request to update plan on database if different
	}
	
	$( "#verification_script" ).css("display","table-row");
}
</script>
<script> //cancel button
$(function() {
$( "#dialog:ui-dialog2" ).dialog( "destroy" );

var id = "<?php echo $id; ?>",
	verifier = "<?php echo $ac["user"]; ?>",
	lead_id = $( "#lead_id" ),
	status = $( "#status" ),
	note = $( "#cancel_note" ),
	tips = $( ".error2" );

function updateTips( t ) {
	tips
		.text( t )
		.addClass( "ui-state-highlight" );
	setTimeout(function() {
		tips.removeClass( "ui-state-highlight", 1500 );
	}, 500 );
}

$( "#dialog-form2" ).dialog({
	autoOpen: false,
	height: 250,
	width: 425,
	modal: true,
	resizable: false,
	draggable: false,
	buttons: {
		"Submit": function() {
			if (status.val() == "")
			{
				updateTips("Select the Status!");
			}
			else if (note.val() == "")
			{
				updateTips("Enter a note!");
			}
			else
			{
				$.get("verification_submit.php?method=cancel", { id: id, verifier: verifier, lead_id: lead_id.val(), status: status.val(), note: note.val() },
				function(data) {
					$( "#dialog-form2" ).dialog( "close" );
					window.location = "verification.php";
				});
			}
		},
		Cancel: function() {
			$( this ).dialog( "close" );
		}
	},
	close: function() {
	}
});
});

function Cancel()
{
	$( "#dialog-form2" ).dialog( "open" );
}
</script>
</head>

<body>
<div id="main_wrapper">

<?php
include "../source/header.php";
include "../source/tpv_menu.php";
?>

<div id="text" class="demo">

<div id="dialog-form" title="Add a Package">
<p class="error">All fields are required</p><br />
<table>
<tr>
<td width="50px">CLI </td>
<td><input type="text" size="15" id="add_cli" style="margin-top:0px;" /></td>
</tr>
<tr>
<td>Plan </td>
<td><select id="add_plan" style="margin-left:0px; width:210px; height:25px; padding:1px 0 0;">
<option></option>
<option disabled="disabled">--- Landline ---</option>
<option>$59.95 12 Month Contract</option>
<option>$64.95 No Contract</option>
<option>$69.95 12 Month Contract</option>
<option>$74.95 No Contract</option>
<option>$99.95 No Contract</option>
<option>$129.95 12 Month Contract</option>
<option>$139.95 No Contract</option>
<option>Addon</option>
<option>Duet</option>
<option disabled="disabled">--- Internet ---</option>
<option>ADSL 15GB 24 Month Contract</option>
<option>ADSL 500GB 24 Month Contract</option>
<option>ADSL Unlimited 24 Month Contract</option>
<option disabled="disabled">--- Bundle ---</option>
<option>Bundle $89.95 24 Month Contract</option>
<option>Bundle $102.95 24 Month Contract</option>
<option>Bundle $104.95 24 Month Contract</option>
<option>Bundle $119.95 24 Month Contract</option>
<option>Bundle $129.95 24 Month Contract</option>
<option>Bundle $132.95 24 Month Contract</option>
<option>Bundle $134.95 24 Month Contract</option>
<option>Bundle $142.95 24 Month Contract</option>
<option>Bundle $144.95 24 Month Contract</option>
<option>Bundle $159.95 24 Month Contract</option>
</select></td>
</tr>
</table>
</div>

<div id="dialog-form2" title="Cancel Verification">
<p class="error2">All fields are required</p>
<table>
<tr>
<td width="50px">Status </td>
<td><select id="status" style="width:120px; height:auto; padding:0px; margin-left:0;">
<option></option>
<option>Declined</option>
<option>Line Issue</option>
<option>Hold</option>
</select></td>
</tr>
<tr>
<td width="50px">Note </td>
<td><textarea id="cancel_note" rows="5" style="width:350px; resize:none;"></textarea></td>
</tr>
</table>
</div>

<?php
if ($id == "")
{
?>
<div id="get_sale_table" style="margin-top:75px;">
    <table>
        <tr>
            <td><p>Enter the Customer's Sale ID</p></td>
            <td><input type="text" name="id" id="id" size="25"/></td>
            <td><input type="button" class="get_sale_btn" onclick="Get_Sale()"/></td>
        </tr>
    </table>
    <center><p class="error" style="color:#C00;"><?php if($_GET["er"] == "exp") { echo "Lead has expired!"; } ?><?php if(substr($_GET["er"],0,1) == "c") { echo "Lead not assigned to " . substr($_GET["er"],1) . "!"; } ?></p></center>
</div>
<?php
}
else
{
	$q = mysql_query("SELECT * FROM sales_customers WHERE id = '" . mysql_escape_string($id) . "'") or die (mysql_error());
	$data = mysql_fetch_assoc($q);
	
	$q2 = mysql_query("SELECT alias FROM auth WHERE user = '$data[agent]'") or die (mysql_error());
	$salias = mysql_fetch_row($q2);
	
	$qc2 = mysql_query("SELECT * FROM leads WHERE sid = '$data[lead_id]'") or die(mysql_error());
	$check2 = mysql_fetch_assoc($qc2);
	
	if ($data["centre"] != $check2["centre"])
	{
		$link = "../tpv/verification.php?er=c" . $data["centre"];
		echo "<script>window.location = '$link';</script>";
		exit;
	}
	elseif (time() <= strtotime($check2["start_date"]) || time() >= strtotime($check2["end_date"]))
	{
		$link = "../tpv/verification.php?er=exp";
		echo "<script>window.location = '$link';</script>";
		exit;
	}

	switch ($data["type"])
	{
		case "Business":
		$bus="selected";
		break;
		case "Residential":
		$res="selected";
		break;
	}
?>
<!--<script language="javascript" type="text/javascript">   	    
window.onbeforeunload = function() {
        return "Dude, are you sure you want to leave? Think of the kittens!";
    }
</script>-->
<input type="hidden" id="lead_id" value="<?php echo $data["lead_id"]; ?>" />
<table border="0" width="100%">
<tr>
<td width="367px" valign="top" id="sale_details_edit">
<table border="0" width="100%">
<tr>
<td colspan="2"><img src="../images/sale_details_header.png" width="90" height="15" /></td>
</tr>
<tr>
<td colspan="2"><img src="../images/line.png" width="80%" height="9" alt="line" /></td>
</tr>
<tr>
<td width="85px">Sale ID </td>
<td><b><?php echo $data["id"]; ?></b></td>
</tr>
<tr>
<td>Sale Agent </td>
<td><b><?php echo $data["agent"] . " (" . $salias[0] . ")"; ?></b></td>
</tr>
<tr>
<td>Centre </td>
<td><b><?php echo $data["centre"]; ?></b></td>
</tr>
<tr>
<td>Campaign </td>
<td><b class="campaign"><?php echo $data["campaign"]; ?></b></td>
</tr>
<tr>
<td>Type </td>
<td><select id="type" style="margin:0; width:100px; height:20px; padding:1px 0 0; font-family:Tahoma, Geneva, sans-serif; font-size:11px;">
<option <?php echo $bus; ?>>Business</option>
<option <?php echo $res; ?>>Residential</option>
</select></td>
</tr>
</table>
</td>
<td width="367px" valign="top" id="sale_details" style="display:none;">
<table border="0" width="100%">
<tr>
<td colspan="2"><img src="../images/sale_details_header.png" width="90" height="15" /></td>
</tr>
<tr>
<td colspan="2"><img src="../images/line.png" width="80%" height="9" alt="line" /></td>
</tr>
<tr>
<td width="85px">Sale ID </td>
<td><b><?php echo $data["id"]; ?></b></td>
</tr>
<tr>
<td>Sale Agent </td>
<td><b><?php echo $data["agent"] . " (" . $salias[0] . ")"; ?></b></td>
</tr>
<tr>
<td>Centre </td>
<td><b><?php echo $data["centre"]; ?></b></td>
</tr>
<tr>
<td>Campaign </td>
<td><b class="campaign"><?php echo $data["campaign"]; ?></b></td>
</tr>
<tr>
<td>Type </td>
<td><b class="type"></b></td>
</tr>
</table>
</td>
<td width="367px" valign="top">
<table border="0" width="100%">
<tr>
<td colspan="2"><img src="../images/customer_details_header.png" width="128" height="15" /></td>
</tr>
<tr>
<td colspan="2"><img src="../images/line.png" width="80%" height="9" alt="line" /></td>
</tr>
<tr>
<td width="85px">Title </td>
<td><b><?php echo $data["title"]; ?></b></td>
</tr>
<tr>
<td>First Name </td>
<td><b><?php echo $data["firstname"]; ?></b></td>
</tr>
<tr>
<td>Middle Name </td>
<td><b><?php echo $data["middlename"]; ?></b></td>
</tr>
<tr>
<td>Last Name </td>
<td><b><?php echo $data["lastname"]; ?></b></td>
</tr>
</table>
</td>
</tr>
<tr id="tpv_notes" style="display:table-row;">
<td colspan="2">
<table border="0" width="100%">
<tr>
<td><br /><img src="../images/tpv_notes_header.png" width="80" height="15" style="padding-left:3px;"/></td>
</tr>
<tr>
<td><img src="../images/line.png" width="100%" height="9" alt="line" /></td>
</tr>
<tr>
<td>
<div style="height:125px; width:99%; overflow:auto; border: 1px solid #eee;">
<?php
$q3 = mysql_query("SELECT * FROM tpv_notes WHERE id = '$id' ORDER BY timestamp DESC") or die (mysql_error());

echo "<table border='0' width='100%'>";
if (mysql_num_rows($q3) == 0)
{
	echo "<tr>";
	echo "<td>No Notes</td>";
	echo "</tr>";
}
else
{
	while ($tpv_notes = mysql_fetch_assoc($q3))
	{
		$q7 = mysql_query("SELECT * FROM auth WHERE user = '$tpv_notes[verifier]'") or die(mysql_error());
		$vname = mysql_fetch_assoc($q7);
		
		echo "<tr>";
		echo "<td>----- " . date("d/m/Y H:i:s", strtotime($tpv_notes["timestamp"])) . " - " . $vname["first"] . " " . $vname["last"] . " -----" . " (" . $tpv_notes["status"] . ")</td>";
		echo "</tr>";
		echo "<tr>";
		echo "<td>" . $tpv_notes["note"] . "</td>";
		echo "</tr>";
	}
}
echo "</table>";
?>
</div>
</td>
</tr>
</table>
</td>
</tr>
<tr id="prev_attempt" style="display:table-row;">
<td colspan="2">
<table width="100%" border="0">
<tr>
<td width="55%" valign="top">
<table border="0" width="100%">
<tr>
<td><img src="../images/previous_attempt_header.png" width="140" height="15" style="padding-left:3px;"/></td>
</tr>
<tr>
<td><img src="../images/line.png" width="100%" height="9" alt="line" /></td>
</tr>
<tr>
<td>
<div style="height:100px; width:99%; overflow:auto; border: 1px solid #eee;">
<?php
$q4 = mysql_query("SELECT * FROM sales_packages WHERE sid = '$id'") or die (mysql_error());
while ($package = mysql_fetch_assoc($q4))
{
	$q5 = mysql_query("SELECT sid FROM sales_packages WHERE cli = '$package[cli]' AND sid != '$id'") or die (mysql_error());
	echo "<table border='0' width='100%'>";
	if (mysql_num_rows($q5) == 0)
	{
		if ($display1 == 0)
		{
			echo "<tr>";
			echo "<td>No Previous Sign Up Attempts</td>";
			echo "</tr>";
			$display1 = 1;
		}
	}
	else
	{
		while ($sid = mysql_fetch_row($q5))
		{
			$q6 = mysql_query("SELECT * FROM sales_customers WHERE id = '$sid[0]'") or die(mysql_error());
			$prev = mysql_fetch_assoc($q6);
			
            echo "<tr>";
			echo "<td><a onclick='View(\"$prev[id]\")' style='cursor:pointer; text-decoration:underline;'>" . $prev["id"] . "</a></td>";
            echo "<td>" . date("d/m/Y", strtotime($prev["timestamp"])) . "</td>";
			echo "<td>(" . $package["cli"] . ")</td>";
			echo "<td>" . $prev["centre"] . "</td>";
			echo "<td>" . $prev["status"] . "</td>";
            echo "</tr>";
		}
	}
	echo "</table>";
}
?>
</div>
</td>
</tr>
</table>
</td>
<td width="45%" valign="bottom">
<table border="0" width="100%">
<tr>
<td>
<img src="../images/verification_fill_bg.png" width="315" height="104" />
</td>
</tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
<tr id="selected_packages" style="display:table-row;">
<td colspan="2">
<table border="0" width="100%">
<tr>
<td colspan="2"><img src="../images/selected_packages_header.png" width="134" height="15" style="padding-left:3px;"/></td>
</tr>
<tr>
<td colspan="2"><img src="../images/line.png" width="100%" height="9" alt="line" /></td>
</tr>
<tr>
<td colspan="2">
<div id="users-contain" class="ui-widget">
<table id="users" class="ui-widget ui-widget-content" width="99%" style="margin-top:0px;">
<thead>
<tr class="ui-widget-header ">
<th>CLI</th>
<th colspan="3">Plan</th>
</tr>
</thead>
<tbody id="packages">
<script>
var id = "<?php echo $_GET['id']; ?>";
$( "#packages" ).load('packages.php?id=' + id);
</script>
</tbody>
</table>
</div>
</td>
</tr>
<tr valign="bottom">
<td align="left"><input type="button" onclick="Add_Package()" class="addpackage" /></td>
<td align="right">
<?php
$q8 = mysql_query("SELECT * FROM sales_packages WHERE sid = '$id'") or die (mysql_error());
if (mysql_num_rows($q8) == 1)
{
	$pack = mysql_fetch_assoc($q8);
?>
<input type="hidden" id="plan" value="<?php echo $pack["plan"] ?>" />
<?php
}
else
{
?>
<select id="plan" style="margin:0 1px 10px 0; width:200px; height:20px; padding:1px 0 0; font-family:Tahoma, Geneva, sans-serif; font-size:11px;">
<?php
while ($package2 = mysql_fetch_assoc($q8))
{
	echo "<option>" . $package2["plan"] . "</option>";
}
?>
</select>
<?php
}
?>
<input type="button" onclick="LoadScript()" class="loadscript" />
<input type="button" onclick="Cancel()" class="cancelform" />
</td>
</tr>
</table>
</td>
</tr>
<tr id="verification_script" style="display:none;">
<td colspan="2">
<table border="0" width="100%">
<tr valign="bottom">
<td align="left"><br /><img src="../images/verification_script_header2.png" width="140" height="15" style="padding-left:3px;"/></td>
<td align="right"><input type="button" class="notes" /></td>
</tr>
<tr>
<td colspan="2"><img src="../images/line.png" width="100%" height="9" alt="line" /></td>
</tr>
<tr>
<td colspan="2">
<div id="script_text" style="border:0; margin-top:0; padding:5px 5px 0; width:100%;">
<iframe src="../script/script_tpv.php" id="script" name="script" width="100%" height="380px" frameborder="0">
</iframe>
</td>
</tr>
</table>
</td>
</tr>
</table>
<?php
}
?>

</div>
</div> 
<?php
include "../source/footer.php";
?>
</body>
</html>